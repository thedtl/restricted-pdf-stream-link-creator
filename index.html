<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Link Generator | DTL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (your existing styles here, unchanged) */
        :root { /* ‚Ä¶ */ }
        body { /* ‚Ä¶ */ }
        /* ‚Ä¶ entire CSS block unchanged ‚Ä¶ */
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><div class="logo-icon">üìö</div><span>Chapter Link Generator</span></div>
            <div class="staff-badge">üîí Staff Tool</div>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-header"><span class="step">1</span><h2>Staff Authentication</h2></div>
            <div class="card-body">
                <div class="form-group">
                    <label for="staffPassword">Staff Password <span id="passwordSaved" class="password-saved" style="display: none;">‚úì Saved</span></label>
                    <input type="password" id="staffPassword" placeholder="Enter staff password">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="step">2</span><h2>Book Information</h2></div>
            <div class="card-body">
                <div class="form-group">
                    <label for="citation">Citation <span class="label-hint">(First Last, Book Title)</span></label>
                    <input type="text" id="citation" placeholder="John Smith, A History of Ancient Rome">
                </div>
                <div class="form-group">
                    <label for="dropboxUrl">Dropbox Link</label>
                    <input type="text" id="dropboxUrl" placeholder="https://www.dropbox.com/...">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <button class="btn btn-primary" onclick="analyzePDF()">
                    Generate Chapter Links
                </button>
            </div>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header"><span class="step">‚úì</span><h2>Ready to Copy</h2></div>
            <div class="status-bar" id="statusBar" style="display: none;"></div>
            <div class="card-body" id="resultsBody">
                <div class="result-info" id="resultInfo"></div>
                <div class="code-output"><pre id="codeOutput"></pre></div>
                <button class="btn btn-success" onclick="copyCode()">Copy Code to Clipboard</button>
                <div class="copy-success" id="copySuccess">Copied! Paste into LibGuides.</div>
                <div class="preview-section">
                    <div class="preview-label">Preview (how it will look)</div>
                    <div class="preview-box" id="previewBox"></div>
                </div>
            </div>
        </div>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // CONFIG
        const VIEWER_URL = "https://thedtl.github.io/pdf-reader-streamer/pdfjs-5.4.624-dist/web/viewer.html";
        const WORKER_URL = "https://dtl-pdf-stream.reference-dfe.workers.dev";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let generatedCode = '';

        document.addEventListener('DOMContentLoaded', () => {
            const savedPassword = sessionStorage.getItem('dtl_staff_password');
            if (savedPassword) {
                document.getElementById('staffPassword').value = savedPassword;
                document.getElementById('passwordSaved').style.display = 'inline-flex';
            }
        });

        document.getElementById('staffPassword').addEventListener('change', function () {
            if (this.value) {
                sessionStorage.setItem('dtl_staff_password', this.value);
                document.getElementById('passwordSaved').style.display = 'inline-flex';
            } else {
                sessionStorage.removeItem('dtl_staff_password');
                document.getElementById('passwordSaved').style.display = 'none';
            }
        });

        function showStatus(message, type = 'loading') {
            const card = document.getElementById('resultsCard');
            const bar = document.getElementById('statusBar');
            const body = document.getElementById('resultsBody');

            card.style.display = 'block';
            bar.style.display = 'flex';
            bar.className = 'status-bar ' + type;
            body.style.display = type === 'loading' ? 'none' : 'block';

            if (type === 'loading') {
                bar.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
            } else if (type === 'error') {
                bar.innerHTML = '<span>‚ùå</span><span>' + message + '</span>';
            } else {
                bar.style.display = 'none';
            }
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function analyzePDF() {
            const staffPassword = document.getElementById('staffPassword').value.trim();
            const citation = document.getElementById('citation').value.trim();
            const dropboxUrl = document.getElementById('dropboxUrl').value.trim();

            if (!staffPassword) { showStatus('Please enter the staff password', 'error'); return; }
            if (!citation) { showStatus('Please enter the book citation', 'error'); return; }
            if (!dropboxUrl) { showStatus('Please enter a Dropbox URL', 'error'); return; }

            // VALIDATE DROPBOX
            if (!/^https?:\/\/(www\.)?dropbox\.com\/.+$/i.test(dropboxUrl)) {
                showStatus('This doesn\'t look like a Dropbox URL', 'error');
                return;
            }

            // NORMALIZE DIRECT DROPBOX DL
            let dropboxDirectUrl;
            try {
                const urlObj = new URL(dropboxUrl);
                if (urlObj.searchParams.has('dl')) {
                    urlObj.searchParams.set('dl', '1');
                } else {
                    urlObj.searchParams.append('dl', '1');
                }
                dropboxDirectUrl = urlObj.toString();
            } catch (e) {
                showStatus('Invalid URL format', 'error');
                return;
            }

            showStatus('Loading PDF and extracting chapters...');

            try {
                const analyzeUrl = WORKER_URL + '/analyze?' + new URLSearchParams({
                    password: staffPassword,
                    dropbox: dropboxDirectUrl
                });

                const pdf = await pdfjsLib.getDocument({ url: analyzeUrl }).promise;

                const totalPages = pdf.numPages;
                showStatus('Extracting bookmarks...');

                const outline = await pdf.getOutline();
                if (!outline || outline.length === 0) {
                    showStatus('No bookmarks found in this PDF. Please add bookmarks and try again.', 'error');
                    return;
                }

                const chapters = await extractChapters(pdf, outline, totalPages);
                if (chapters.length === 0) {
                    showStatus('Could not extract chapter information.', 'error');
                    return;
                }

                showStatus('Generating secure chapter links...');

                const signResponse = await fetch(WORKER_URL + '/batch-sign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: staffPassword,
                        dropbox: dropboxDirectUrl,
                        chapters: chapters.map(ch => ({
                            title: ch.title,
                            start: ch.start,
                            end: ch.end
                        })),
                        download: false,
                        expires: 0
                    })
                });

                const signData = await signResponse.json();
                if (signData.error) { throw new Error(signData.error); }

                generateOutput(citation, chapters, signData.tokens, totalPages);

            } catch (error) {
                console.error(error);
                showStatus('Error: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        async function extractChapters(pdf, outline, totalPages) {
            const chapters = [];
            for (let i = 0; i < outline.length; i++) {
                const item = outline[i];
                const nextItem = outline[i + 1];
                try {
                    let startPage = await getPageNumber(pdf, item);
                    if (startPage === null) continue;
                    let endPage;
                    if (nextItem) {
                        const nextStart = await getPageNumber(pdf, nextItem);
                        endPage = nextStart !== null ? nextStart - 1 : totalPages;
                    } else {
                        endPage = totalPages;
                    }
                    chapters.push({ title: item.title.trim(), start: startPage, end: endPage });
                } catch (e) {}
            }
            return chapters;
        }

        async function getPageNumber(pdf, item) {
            try {
                let dest = item.dest;
                if (typeof dest === 'string') {
                    dest = await pdf.getDestination(dest);
                }
                const pageIndex = await pdf.getPageIndex(dest[0]);
                return pageIndex + 1;
            } catch { return null; }
        }

        function getChapterUrl(token) {
            return VIEWER_URL + '?token=' + encodeURIComponent(token);
        }

        function generateOutput(citation, chapters, tokens, totalPages) {
            let linksHtml = '';
            chapters.forEach((ch, i) => {
                const url = getChapterUrl(tokens[i].token);
                linksHtml += `<li><a href="${url}">${escapeHtml(ch.title)}</a></li>\n`;
            });

            generatedCode = `
<!-- ${escapeHtml(citation)} - Chapter Links -->
<style>/* your embedded styles */</style>
<div class="dtl-chapters">
  <div class="dtl-chapters-header" onclick="this.parentElement.classList.toggle('open')" tabindex="0">
    <span class="dtl-chapters-arrow">‚ñ∂</span>
    <span class="dtl-chapters-citation">${escapeHtml(citation)}</span>
  </div>
  <div class="dtl-chapters-list"><ul>
${linksHtml}  </ul></div>
</div>`;

            document.getElementById('resultInfo').innerText = `${chapters.length} chapters extracted from a ${totalPages}-page PDF`;
            document.getElementById('codeOutput').textContent = generatedCode;
            document.getElementById('previewBox').innerHTML = generatedCode;
            showStatus('', 'success');
        }

        function copyCode() {
            navigator.clipboard.writeText(generatedCode).then(() => {
                document.getElementById('copySuccess').classList.add('show');
                setTimeout(() => document.getElementById('copySuccess').classList.remove('show'), 3000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
